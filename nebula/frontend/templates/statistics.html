{% extends "layout.html" %}
{% block body %}
<!-- Botón para descargar métricas físicas si aplica -->
{% if scenario_name and deployment_type == 'physical' %}
<!-- El botón ahora está en la barra superior -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const btn = document.getElementById('download-metrics-btn-navbar');
        let autoDownloadInterval = null;
        async function downloadMetrics(e, isAuto = false) {
            if (e) e.preventDefault();
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"></i>Descargando...';
            btn.classList.add('disabled');
            try {
                const response = await fetch(`/platform/api/physical/metrics/download-scenario/{{ scenario_name }}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (response.ok) {
                    if (result.successful_downloads > 0) {
                        if (typeof showAlert === 'function') {
                            showAlert('success', 'New physical metrics found and downloaded.');
                        } else {
                            alert('New physical metrics found and downloaded.');
                        }
                        setTimeout(() => { window.location.reload(); }, 1200);
                    } else {
                        // Mostrar aviso informativo si no hay archivos nuevos
                        if (typeof showAlert === 'function') {
                            showAlert('info', 'No new physical metrics found.');
                        } else {
                            alert('No new physical metrics found.');
                        }
                        btn.innerHTML = originalText;
                        btn.classList.remove('disabled');
                    }
                } else {
                    if (typeof showAlert === 'function') {
                        showAlert('error', `Error downloading metrics: ${result.error || 'Unknown error'}`);
                    } else {
                        alert(`Error downloading metrics: ${result.error || 'Unknown error'}`);
                    }
                    btn.innerHTML = originalText;
                    btn.classList.remove('disabled');
                }
            } catch (e) {
                alert('Network error while downloading metrics.');
                btn.innerHTML = originalText;
                btn.classList.remove('disabled');
            }
        }
        if (btn) {
            btn.addEventListener('click', downloadMetrics);
            // Auto-descarga cada 30s solo si el botón está visible
            autoDownloadInterval = setInterval(() => {
                if (btn && !btn.classList.contains('disabled')) {
                    downloadMetrics(null, true);
                }
            }, 30000);
        }
        // Limpiar el temporizador al salir de la página
        window.addEventListener('beforeunload', function() {
            if (autoDownloadInterval) clearInterval(autoDownloadInterval);
        });
    });
</script>
{% endif %}
<!-- Print statistics_url using jinja2 -->
<!-- {{ statistics_url | safe }} -->
<iframe src="{{ statistics_url | safe }}" width="100%" height="100%" style="border: none; overflow: hidden"></iframe>
<style>
    .navbar {
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block footer %}
{% endblock %}
